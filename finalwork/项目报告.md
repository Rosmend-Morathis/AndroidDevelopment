

# 活动中心场所预约小程序项目报告



## 一、引言

### 概述：

本项目为基于小程序开发的适用于场所调度的预约系统，由南开大学19级本科生罗德明选题进行开发。用户可通过小程序访问预约系统，进行场所预约、记录查询、变更预约、取消预约等操作。

### 背景：

在一般的线下场所预约场景中，用户在进行一次预约的时空开销可能是巨大的，而为了提高用户进行预约的体验感与效率，网上预约逐渐成为人们关注的方向。因此本项目以学校活动中心为原型对场所进行抽象，设计基于小程序的预约系统，以求为用户提供优秀的使用体验。

### 应用场景:

该项目小程序提供了简洁方便的预约系统，用户可以通过小程序进行预约、查询、修改或取消预约。预约系统采用微信云数据库存储记录，对系统后台的管理可通过对数据库操作实现。本项目适用于小型场所预约场景，对于数据库结构稳定的场所应用效果较好。

## 二、需求分析

### 功能性需求

小程序应能进行场所预约、记录查询、变更预约、取消预约等操作，下表列出了小程序开发中提出的功能性需求。

| *需求* | *权重* | *描述*                                       |
| ------ | ------ | -------------------------------------------- |
| *REQ1* | *5*    | *用户使用账号密码登录系统*                   |
| *REQ2* | *3*    | *用户点击预约按钮进入预约界面*               |
| *REQ3* | *5*    | *用户预约完成时，后台数据库应响应记录变动*   |
| *REQ4* | *3*    | *用户可以筛选可用场所*                       |
| *REQ5* | *3*    | *用户可以查询预约记录*                       |
| *REQ6* | *5*    | *用户可以修改已提交的预约*                   |
| *REQ6* | *5*    | *用户可以取消已提交的预约*                   |
| *REQ7* | *4*    | *每个用户同一时段内仅能执行一次预约*         |
| *REQ8* | *4*    | *在场所被预约时间结束后，将其状态重置为空闲* |
| *REQ9* | *3*    | *系统保留近期用户预约记录*                   |



### 非功能性需求

下表列出了小程序开发中提出的非功能性需求。

| *需求* | *权重* | *描述*                     |
| ------ | ------ | -------------------------- |
| *REQ1* | *4*    | *系统界面简洁友好*         |
| *REQ2* | *3*    | *查询页面展示相应信息*     |
| *REQ3* | *3*    | *对用户操作作出实时反馈*   |
| *REQ4* | *2*    | *用户可以导出近期预约记录* |



## 三、技术与功能介绍

### 技术概述

本项目采用了 前端微信小程序 + 后端微信云开发 的架构。

##### 前端部分

前端页面的渲染与路由在微信小程序中单独实现。对用户登录、预约、查询等操作绑定相应事件，当触发事件时向后端传递相应数据，调用后端云函数进行相应操作。

###### 	前端结构

​		前端代码部分主要包括 login, index, rooms, mine, appoint 五个页面的文件{ xxx.js, xxx.wxml, xxx.wxss, xxx.json}，图片image文件夹，工具文件 util.js及项目配置文件{ app.js, app.wxml, app.wxss, app.json, envList.js, project.config.json }

​		<img src="D:\课件\智能移动开发\AndroidDevelopRepo\fp-sc\front-index.png" style="zoom:50%;" />

##### 后端部分

后端使用了云函数与云数据库。云数据库中存储了房间信息，用户信息与预约记录；云函数通过对数据库进行相应增删查改操作来实现用户登录、预约、取消预约等操作。

###### 	云数据库

​		数据库中建立了三个集合 [rooms, users, records] 分别存储房间信息、用户信息与用户预约记录，各集合的属性设计如图：

1. rooms：<img src="D:\课件\智能移动开发\AndroidDevelopRepo\fp-sc\db-rooms-design.png" alt="rooms" style="zoom: 50%;" />
2. records：<img src="D:\课件\智能移动开发\AndroidDevelopRepo\fp-sc\db-records-design.png" alt="rooms" style="zoom:50%;" />
3. users：<img src="D:\课件\智能移动开发\AndroidDevelopRepo\fp-sc\db-users-design.png" alt="rooms" style="zoom:50%;" />	

###### 	云函数

​		本项目设计了4个云函数来实现需求的功能

1. login：此函数实现用户登录逻辑。函数接收前端数据后查询云数据库users表，查找匹配用户。若匹配返回用户信息，若不匹配返回提示信息
2. appoint：此函数实现房间预约逻辑。函数接收前端数据后查询云数据库rooms表，查找匹配房间，并更新状态，完成后向records表中添加相应记录，操作成功后返回成功信息，若操作失败返回错误信息。
3. appointmentCancel：此函数实现取消房间预约逻辑。函数接收前端数据后查询云数据库records表查找匹配记录并更新，完成后以上一条最近记录为标准对相应房间状态进行更新，操作成功后返回成功信息，若操作失败返回错误信息。
4. updateDatabase：此函数实现预约记录与房间状态的自动更新逻辑。函数通过定时触发器调用，间隔一小时根据当前时间更新记录状态与房间状态。

### 功能介绍

###### 功能概述

​		该小程序设计了非常简洁的预约系统，用户登录系统后可以进行预约房间，取消预约的操作，用户在使用时可以根据房间状态、房间类型与房间所在楼层筛选，且可以查看近期的个人预约记录。数据库的自然更新由云端自动进行。

​		用例图：<img src="D:\课件\智能移动开发\AndroidDevelopRepo\fp-sc\usecase.png" alt="usecase" style="zoom: 50%;" />

​		类图：<img src="D:\课件\智能移动开发\AndroidDevelopRepo\fp-sc\class-diagram.png" alt="usecase" style="zoom:60%;" />

###### 登录功能

用户打开小程序进入登录页面，输入工号与密码并点击登录按钮，此时登录页函数login(data)获取用户输入数据，调用云函数login()。在云函数login()内部进行信息验证：

- 查找users表中 userid == 输入工号 的记录
  - 若找到，验证 userpwd == 输入密码
    - 若通过，返回成功信息
    - 若不通过，返回错误信息（密码错误）
  - 若未找到，返回错误信息（账户不存在）

登录页函数 login(data) 收到云函数返回的信息后暂存，调用wx.showToast()反馈给用户。

<img src="D:\课件\智能移动开发\AndroidDevelopRepo\fp-sc\login-0.png" style="zoom: 50%;" /><img src="D:\课件\智能移动开发\AndroidDevelopRepo\fp-sc\login-1.png" style="zoom: 50%;" /><img src="D:\课件\智能移动开发\AndroidDevelopRepo\fp-sc\login-2.png" style="zoom: 50%;" />

若云函数返回了成功信息，页面将跳转至首页页面并更新系统的 userid 字段

###### 退出登录

用户通过点按退出登录按钮触发函数 logout()，清除用户信息并回退到登录页面。

###### 预约房间

用户点击列表页某一房间对应的预约按钮时，会触发 bindtap 事件跳转到预约页面，小程序会自动传递该房间的信息到预约页面进行渲染。

<img src="D:\课件\智能移动开发\AndroidDevelopRepo\fp-sc\choosetime.png" style="zoom: 50%;" />

在预约页面中，用户选择完日期与时间后，点按预约按钮时调用appoint()函数。在函数中，首先调用 util.js 中的 formatTime() 与 concatDate() 将用户选择的日期与时间进行格式处理并生成相同格式的提交时间。调用云函数 appoint() ，处理后的时间与页面中的房间信息一同作为参数，在云函数 appoint()内：

- 在 rooms 表查询所预约的房间
  - 状态为“空闲”，则更新为“预约中”，置标记为 true
  - 状态为非“空闲”，则查询 records 表中与该房间相关的记录
    - 若本次预约与已有记录时间不冲突，置标记为 true
    - 若本次预约与已有记录时间冲突，置标记为 false
- 若标记为 true，在 records 表添加相应记录，返回成功信息
- 若标记为 false，返回错误信息

预约页面函数 appoint() 接收到云端返回的信息后暂存，调用wx.showToast()反馈给用户。若云函数返回了成功信息，页面将回退至列表页。

###### 取消预约

用户点击用户页内状态为”预约中“的记录右侧的取消按钮时，会触发 bindtap 事件，弹窗提示用户是否进行取消操作。

<img src="D:\课件\智能移动开发\AndroidDevelopRepo\fp-sc\cancel-warning.png" alt="cancel-warning" style="zoom: 50%;" />

获得授权后小程序会自动传递该房间的信息到云函数 appintmentCancel() 进行取消操作：

- 查询 records 表中对应记录并修改状态为”已取消“
- 查询 records 表中该房间的近期记录，筛选出”预约中“的记录
  - 若结果为空（该房间无人预约），更新 rooms 表中该房间状态为"空闲"
  - 若结果不为空（该房间有人预约），更新 rooms 表中该房间状态为"预约中"
- 返回消息

函数 cancel() 接收到云端返回的信息后暂存，调用wx.showToast()反馈给用户。

###### 更新数据库

小程序在云端设置定时触发器，每小时调用一次云函数 updateDatabase() 来更新云数据库中 rooms 表 与 records 表中的记录。

记当前时间为 now，某条记录中预约的开始时间为 start ，结束时间为 end 。

- 升序查询 records 表中状态为 “预约中” 的记录逐条检查
  - 若 now < start (未到预约开始时间)
    - 更新 rooms 表内相应房间状态为 “预约中”
  - 若 start <= now (已过预约开始时间)
    - 更新该记录状态为 “已完成"
  - 若 now < end (当前房间正被使用中)
    - 更新 rooms 表内相应房间状态为 “使用中”
  - 若 now >= end (已过预约结束时间)
    - 更新 rooms 表内相应房间状态为 “空闲”

###### 页面显示相关功能

在列表页设计了筛选栏，用户可以通过点按相应按钮展开子选项，点按进行筛选。

按钮 ”全部“ 绑定了响应事件 selectAll(e)，该函数查询数据库 rooms 表，将记录存储页面 data 数据供前端渲染。该函数在列表页初始化时会自动调用。

每个父级按钮都绑定了响应事件 selectRooms(e)，函数通过传入参数来修改页面的 data 数据，前端重新渲染出对应的子选项。在展开子菜单时渲染出灰色阴影层来突出显示筛选栏，同时防止误触下方内容。在点按灰色阴影层时触发 touchShade(e)事件，关闭所有展开的子选项，灰色阴影层消失。

每个子选项按钮根据不同绑定了各自的响应事件：selectByType(e)，selectByFloor(e)，selectByState(e)。函数内逻辑相同，直接查询数据库 rooms 表中符合筛选条件的记录存储到页面 data 数据中，前端重新进行渲染。

预约页面的日期与时间采用 picker 标签书写，为一般的日期与时间选择器。目前设计为仅允许在当天及之后的时间段内预约，且不可跨天预约。预约时间在 8:00 至 22:00 之间。

###### 生命周期

在用户登录后，各个页面的 onLoad() 方法都会同步获取全局的 userid 字段

列表页在显示时，onShow() 方法内会调用 selectAll() 函数默认获取所有房间

用户页初始化时，onLoad() 方法获取用户信息存储在 data 中进行渲染，在调用onShow()，onPullDownRefresh() 方法时，调用getRecords(e) 函数获取该用户的预约记录

预约页初始化时，onLoad() 方法接收列表页传递的信息，调用工具类 util 中的方法重新调整数据格式后存入 data 中。



## 四、功能展示与使用方法

<u>**AppID:  wx122c84d38d52f165**</u>

使用小程序时请用以下用户进行登录测试

​    测试用户：[
​        {工号：100001， 密码：100001},
​        {工号：100002， 密码：100002},
​        {工号：100007， 密码：100007},
​        {工号：100008， 密码：100008}
​    ]

小程序界面：

​		<img src="D:\课件\智能移动开发\AndroidDevelopRepo\fp-sc\login-page.png" style="zoom: 33%;" /><img src="D:\课件\智能移动开发\AndroidDevelopRepo\fp-sc\index-page.png" style="zoom: 33%;" /><img src="D:\课件\智能移动开发\AndroidDevelopRepo\fp-sc\list-page.png" style="zoom: 33%;" /><img src="D:\课件\智能移动开发\AndroidDevelopRepo\fp-sc\user-page.png" style="zoom: 33%;" /><img src="D:\课件\智能移动开发\AndroidDevelopRepo\fp-sc\apt-page.png" style="zoom:33%;" />

用户键入工号与密码进行登录，在列表页可以点击顶部筛选按钮筛选房间，点按要预约的房间名右侧的预约按钮，即可打开预约界面，在用户界面中可查看预约记录，预约中记录可以点击右侧”取消“按钮进行取消操作。

### ~本次迭代~

1. 完成预约页面的布局
2. 完成房间预约逻辑的实现
3. 完成取消预约逻辑的实现
4. 完善用户登录与退出登录功能
5. 调整了列表页与用户页的数据渲染样式



